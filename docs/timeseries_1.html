<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; 시계열분석 – 직업환경연구방법</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./InterruptedTS.html" rel="next">
<link href="./Dose_Response_Model.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-a8378a0342da607bf6aa9ac04725c156.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-424117795b1f6bc5b90be9cdae97709d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./timeseries_1.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">시계열분석</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">직업환경연구방법</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">소개</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">개요</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./MetaAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">메타분석</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Dose_Response_Model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Dose Response Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./timeseries_1.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">시계열분석</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./InterruptedTS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">중단된 시계열 분석</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">4.1</span> introduction</a></li>
  <li><a href="#공기-오염와-건강" id="toc-공기-오염와-건강" class="nav-link" data-scroll-target="#공기-오염와-건강"><span class="header-section-number">4.2</span> 공기 오염와 건강</a>
  <ul class="collapse">
  <li><a href="#시작" id="toc-시작" class="nav-link" data-scroll-target="#시작"><span class="header-section-number">4.2.1</span> 시작</a></li>
  <li><a href="#환경오염과-건강을-어떻게-연구할-것인가가" id="toc-환경오염과-건강을-어떻게-연구할-것인가가" class="nav-link" data-scroll-target="#환경오염과-건강을-어떻게-연구할-것인가가"><span class="header-section-number">4.2.2</span> 환경오염과 건강을 어떻게 연구할 것인가가</a></li>
  </ul></li>
  <li><a href="#pm10과-심혈관-질환-사망률에-대한-시뮬레이션-연구" id="toc-pm10과-심혈관-질환-사망률에-대한-시뮬레이션-연구" class="nav-link" data-scroll-target="#pm10과-심혈관-질환-사망률에-대한-시뮬레이션-연구"><span class="header-section-number">4.3</span> PM10과 심혈관 질환 사망률에 대한 시뮬레이션 연구</a></li>
  <li><a href="#사례-연구-독감과-자살" id="toc-사례-연구-독감과-자살" class="nav-link" data-scroll-target="#사례-연구-독감과-자살"><span class="header-section-number">4.4</span> 사례 연구 : 독감과 자살</a>
  <ul class="collapse">
  <li><a href="#실습-데이터" id="toc-실습-데이터" class="nav-link" data-scroll-target="#실습-데이터"><span class="header-section-number">4.4.1</span> 실습 데이터</a></li>
  <li><a href="#simple-time-related-variable-adjusting-regression" id="toc-simple-time-related-variable-adjusting-regression" class="nav-link" data-scroll-target="#simple-time-related-variable-adjusting-regression"><span class="header-section-number">4.4.2</span> simple time-related variable adjusting regression</a></li>
  <li><a href="#arima" id="toc-arima" class="nav-link" data-scroll-target="#arima"><span class="header-section-number">4.4.3</span> ARIMA</a></li>
  </ul></li>
  <li><a href="#분석-및-예측-회귀-분석" id="toc-분석-및-예측-회귀-분석" class="nav-link" data-scroll-target="#분석-및-예측-회귀-분석"><span class="header-section-number">4.5</span> 분석 및 예측, 회귀 분석</a></li>
  <li><a href="#arima-1" id="toc-arima-1" class="nav-link" data-scroll-target="#arima-1"><span class="header-section-number">4.6</span> ARIMA</a>
  <ul class="collapse">
  <li><a href="#arima-감기-자살-aic" id="toc-arima-감기-자살-aic" class="nav-link" data-scroll-target="#arima-감기-자살-aic"><span class="header-section-number">4.6.1</span> arima 감기 자살 , AIC</a></li>
  </ul></li>
  <li><a href="#aic-bic-in-generalize-additive-model" id="toc-aic-bic-in-generalize-additive-model" class="nav-link" data-scroll-target="#aic-bic-in-generalize-additive-model"><span class="header-section-number">4.7</span> AIC BIC in generalize additive model</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="tsregression" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">시계열분석</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">4.1</span> introduction</h2>
<p>시계열적 자료를 분석하고 나타나는 현상과 특정 요인과 관련성을 탐색해보는 시간입니다. 예를 들어 미세먼지가 높은 날 심혈관 질환이 발생하는가?에 대한 질문에 답하기 위해서 생가할 것이 몇가지 있습니다. 미세먼지가 높은 날이란? 심혈관 질환 사망이 높은 날이란? 이 두가지 요소를 검토하게 됩니다. <br> 그런데 심혈관 질환의 사망은 요일마다 다르고, 계절에 따라 변동하며, 장기 적으로는 점차 증가 또는 감소를 합니다. 그런데 미세먼지도 점차 증가하고 있으니, 단순 상관관계를 보면 미세먼지도 증가 심혈관 사망도 증가하면 양의 관련성을 보이게 됩니다. 마찬가지로 GDP와 자살의 관계를 보면 어떨까요? 우리나라의 자살률은 증가하고 있습니다. 그런데 GDP도 증가하고 있습니다. 그러니 GDP의 증가와 자살의 증가는 양의 상관관계가 있다고 나옵니다. 맞나요? 네 심혈관 사망, 자살의 증가의 계절적 요소, 장기간 추세(trend)가 아니라 변동이 미세먼지나 GDP의 변동과 어떠한 관계가 있는지가 우리의 궁금증일 것 입니다. 이러한 궁금증을 R을 이용해서 풀어보도록 하겠습니다.</p>
</section>
<section id="공기-오염와-건강" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="공기-오염와-건강"><span class="header-section-number">4.2</span> 공기 오염와 건강</h2>
<p>the original book is https://www.springer.com/gp/book/9780387781662 이 책에서 중요한 부분을 요약하고, 몇몇을 추가하여 진행하겠습니다. 원본을 읽어 보시는 것을 추천해 드립니다.</p>
<section id="시작" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="시작"><span class="header-section-number">4.2.1</span> 시작</h3>
<p>이 책은 NMMAPSlite 패키지를 사용했지만, 해당 패키지와 데이터는 사용하기 쉽지 않습니다. 따라서 Gasparrini의 dlnm 패키지와 해당 패키지의 데이터가 이 요약 튜토리얼(https://github.com/gasparrini/dlnm/tree/master/data)에서 사용되었습니다.</p>
<p>필요한 라이브러리를 불러옵니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(tidyverse)) <span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(dlnm)) <span class="fu">install.packages</span>(<span class="st">"dlnm"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(ggplot2)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(readxl)) <span class="fu">install.packages</span>(<span class="st">"readxl"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(lubridate)) <span class="fu">install.packages</span>(<span class="st">"lubridate"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(plotly)) <span class="fu">install.packages</span>(<span class="st">"plotly"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(forecast)) <span class="fu">install.packages</span>(<span class="st">"forecast"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(gsheet)) <span class="fu">install.packages</span>(<span class="st">"gsheet"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(Hmisc)) <span class="fu">install.packages</span>(<span class="st">"Hmisc"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(mgcv)) <span class="fu">install.packages</span>(<span class="st">"mgcv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="환경오염과-건강을-어떻게-연구할-것인가가" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="환경오염과-건강을-어떻게-연구할-것인가가"><span class="header-section-number">4.2.2</span> 환경오염과 건강을 어떻게 연구할 것인가가</h3>
<section id="tell-a-story" class="level4" data-number="4.2.2.1">
<h4 data-number="4.2.2.1" class="anchored" data-anchor-id="tell-a-story"><span class="header-section-number">4.2.2.1</span> tell a story</h4>
<p>’매일 발생하는 대기 오염 수준의 변화와 매일 발생하는 사망자 수 변화 사이의 관계’에 대한 이야기를 하고 싶습니다. 따라서, 예측보다는 연관성을 추정하는 데 유용한 통계 모델이 필요합니다.</p>
</section>
<section id="추정-vs.-예측" class="level4" data-number="4.2.2.2">
<h4 data-number="4.2.2.2" class="anchored" data-anchor-id="추정-vs.-예측"><span class="header-section-number">4.2.2.2</span> 추정 vs.&nbsp;예측</h4>
<p>과학적으로 흥미로운 질문 중 하나는 “PM10 시계열의 변화가 사망률 시계열의 변화와 관련이 있는가?”입니다. 이 질문은 본질적으로 시간에 따라 변하는 건강 결과 <span class="math inline">\(y_{t}\)</span>와 시간에 따라 변하는 노출 <span class="math inline">\(x_{t}\)</span> 간의 관계를 탐구합니다. 이를 간단한 선형 모델로 표현하면 (식 1.1)과 같이 나타낼 수 있습니다.</p>
<p><span class="math display">\[Y_{i}=\beta_{0}+\beta_{1}\textrm{x}_{t}+\epsilon_{t} \tag{1.1}\]</span></p>
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">estimates</th>
<th style="text-align: left;">contents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(\beta_{0}\)</span></td>
<td style="text-align: left;">the mean mortality count</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(\beta_{1}\)</span></td>
<td style="text-align: left;">tthe increase in mortality associated with a unit increase in PM10(<span class="math inline">\(x_{t}\)</span>)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(\epsilon_{t}\)</span></td>
<td style="text-align: left;">a stationary mean zero error process.</td>
</tr>
</tbody>
</table>
<p><span class="math inline">\(\bar{x}_{t}^{Y}\)</span>: Y라는 특정 변수의 t 시점에서의 평균값을 의미합니다. <span class="math inline">\(\bar{x}_{t}\)</span>: t 시점에서의 Y 변수의 실제 값을 의미합니다.</p>
<p>예를 들어, 노출 시계열 <span class="math inline">\(x_{t}\)</span>를 가져와서 두 부분으로 분해한다고 가정해 봅시다: <strong>평균(<span class="math inline">\(\bar{x}{t}^{Y}\)</span>) + 편차(<span class="math inline">\(x{t} - \bar{x}_{t}^{Y}\)</span>)</strong></p>
<p><strong>average:</strong> <span class="math inline">\(\bar{x}_{t}^{Y}\)</span></p>
<p><strong>deviation:</strong> <span class="math inline">\(x_{t} - \bar{x}_{t}^{Y}\)</span></p>
<p>따라서 우리는 (1.1)을 아래와 같이 재구성할 수 있습니다:</p>
<p><span class="math display">\[Y_{t}=\beta_{0}+
\beta_{1}\bar{x}_{t}^{Y}+\beta_{2}(x_{t} - \bar{x}_{t}^{Y})
+\epsilon_{t} \tag{1.2}\]</span></p>
<p>모델 (1.2)는 <span class="math inline">\(\beta_1 = \beta_2\)</span>라면 모델 (1.1)과 동일하지만, 모델 (1.2)는 이 둘이 같을 필요는 없습니다.</p>
<p>같은 맥락에서, 연간 평균은 계절 평균 또는 월간 평균(<span class="math inline">\(z_{t}\)</span>)으로 분해될 수 있습니다.</p>
<p><span class="math display">\[z_{t} = \bar{z}_{t}^{S}+(z_{t} - \bar{z}_{t}^{S}) \tag{1.3}\]</span> So, we can use following model</p>
<p><span class="math display">\[Y_{t}=\beta_{0}+
\beta_{1}\bar{x}_{t}^{Y}+\beta_{2}\bar{z}_{t}^{S}+\beta_{3}(z_{t} - \bar{z}_{t}^{S})
+\epsilon_{t} \tag{1.2}\]</span></p>
<p>한 단계 더 나아가, 주간 이동 평균(<span class="math inline">\(u_{t}\)</span>)을 추가하거나 분해할 수 있습니다: <span class="math display">\[u_{t} = \bar{u}_{t}^{W}+(u_{t} - \bar{u}_{t}^{W}) \tag{1.4}\]</span></p>
<p>잔차 변동(<span class="math inline">\(r_{t}\)</span>)을 <span class="math inline">\(r_{t} = (u_{t} - \bar{u}_{t}^{W})\)</span>로 정의하면, 확장된 모델은 이제 다음과 같습니다:</p>
<p><span class="math display">\[Y_{t}=\beta_{0}+
\beta_{1}\bar{x}_{t}^{Y}+\beta_{2}\bar{z}_{t}^{S}+\beta_{3}\bar{u}_{t}^W +\beta_{4}r_{t}
+\epsilon_{t} \tag{1.5}\]</span></p>
<p>매개변수 <span class="math inline">\(\beta_{4}\)</span>는 <span class="math inline">\(Y_{t}\)</span>와 <span class="math inline">\(x_{t}\)</span>의 주간 이하 변동 사이의 연관성을 설명합니다 (연간, 계절, 주간 변동을 조정한 후).</p>
<blockquote class="blockquote">
<p><strong>질문 및 토론:</strong> <span class="math inline">\(\beta_{4}\)</span>의 의미는 무엇인가요?</p>
</blockquote>
</section>
</section>
</section>
<section id="pm10과-심혈관-질환-사망률에-대한-시뮬레이션-연구" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="pm10과-심혈관-질환-사망률에-대한-시뮬레이션-연구"><span class="header-section-number">4.3</span> PM10과 심혈관 질환 사망률에 대한 시뮬레이션 연구</h2>
<p>먼저, 시뮬레이션 데이터를 사용하여 시계열 데이터 분석을 이해해보겠습니다.</p>
<blockquote class="blockquote">
<p>x를 날짜로 생각하고, 가상으로 300일 동안 랜덤 변수 y1과 PM10(미세먼지)을 4.5배 곱한 값을 생성해봅시다.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>x  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">300</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> <span class="dv">5</span><span class="sc">*</span><span class="fu">rnorm</span>(<span class="dv">300</span>, <span class="at">sd=</span>.<span class="dv">1</span>)<span class="sc">+</span><span class="dv">15</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>pm <span class="ot">&lt;-</span> y1<span class="sc">*</span><span class="fl">4.5</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, pm, <span class="at">type=</span><span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/random variable-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>여기서는 장기적인 추세가 점진적으로 증가한다고 가정하고, sin() 함수를 통해 계절적 요인을 추가했으며, 이를 0.03으로 곱했습니다.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>y2 <span class="ot">&lt;-</span> y1<span class="sc">*</span><span class="dv">5</span><span class="sc">+</span> <span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span><span class="dv">5</span><span class="sc">+</span> x <span class="sc">*</span> <span class="fl">0.03</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>y2[y2<span class="sc">&lt;</span> <span class="dv">0</span>]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>y3<span class="ot">&lt;-</span><span class="fu">round</span>(y2)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y3, <span class="at">type=</span><span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/seasonal randome-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>지연 효과와 특정 이벤트가 있는 날을 추가해봤습니다. 그리고 데이터프레임을 만들었습니다</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>lag <span class="ot">&lt;-</span><span class="dv">6</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 79.58667</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>death <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">80</span>,<span class="dv">79</span>,<span class="dv">81</span>), (lag<span class="sc">/</span><span class="dv">3</span>)), y3[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(y3)<span class="sc">-</span>lag)])  </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>event <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">240</span>)) </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>eventd <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">40</span>,<span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">30</span>, <span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">240</span>))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>death2<span class="ot">&lt;-</span>death<span class="sc">+</span>eventd<span class="sc">+</span><span class="dv">10</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x, pm, y3, death, event, death2) </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  x       pm y3 death event death2
1 1 66.09048 76    80     1    130
2 2 67.91320 80    79     1    129
3 3 65.61984 78    81     1    131
4 4 71.08938 84    80     1    130
5 5 68.24139 79    79     1    129
6 6 65.65395 74    81     1    131</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>이제 그래프를 그려봅시다. 처음 50일 동안 이벤트가 있어서 심혈관 사망률이 높습니다. 그 후 심혈관 질환 사망률은 계절적 요소와 함께 천천히 증가합니다. 미세먼지는 랜덤 + 계절적 요소로 생성되었습니다.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, pm, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">140</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">300</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, death2, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.7</span>), <span class="at">type=</span><span class="st">"p"</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>이제 간단한 회귀 분석을 해봅시다. 어떤 관계를 관찰할 수 있나요? 이벤트 기간 동안 많은 사람이 사망했습니다. 하지만 PM10과 심혈관 질환 사망률 사이에는 관계가 없어 보입니다.</p>
</blockquote>
<p>분명히 미세먼지와 관련되도록 시뮬레이션으로 만든 심혈관 질환 사망률 데이터인데요. 왜 그럴까요? 아직 ’지연(lag)’과 ’계절성(seasonality)’이 고려되지 않았습니다</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mt3 <span class="ot">&lt;-</span> <span class="fu">glm</span>(death2 <span class="sc">~</span> x<span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span>pm<span class="sc">+</span>event)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mt3)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Estimate  Std. Error     t value      Pr(&gt;|t|)
(Intercept) 90.10455149 6.861474711  13.1319513  2.476263e-31
x            0.02379324 0.003500538   6.7970236  5.915161e-11
sin(x/2)    -4.41585403 0.308633540 -14.3077581  1.247252e-35
pm          -0.06144597 0.101078610  -0.6079028  5.437196e-01
event       35.05109683 0.757861036  46.2500315 3.230388e-137</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>그래프를 다시 보고, 적합된 선(fitted line)은 어떠한가요?</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, pm, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">140</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">300</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, death2, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.7</span>), <span class="at">type=</span><span class="st">"p"</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>mp3 <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="fu">predict</span>(mt3))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, mp3, <span class="at">col=</span><span class="dv">75</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/plot regression line simple-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>이제 사망률 잔차와 PM10 간의 간단한 회귀 모델입니다. 이게 맞나요?</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mt2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(death2 <span class="sc">~</span> x<span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span>event)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>resid_mt2 <span class="ot">&lt;-</span><span class="fu">resid</span>(mt2)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>risk.m0<span class="ot">&lt;-</span><span class="fu">glm</span>(resid_mt2 <span class="sc">~</span> pm, <span class="at">family=</span>gaussian)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(risk.m0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = resid_mt2 ~ pm, family = gaussian)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)  4.14114    6.79037    0.61    0.542
pm          -0.06128    0.10043   -0.61    0.542

(Dispersion parameter for gaussian family taken to be 14.18007)

    Null deviance: 4230.9  on 299  degrees of freedom
Residual deviance: 4225.7  on 298  degrees of freedom
AIC: 1650.9

Number of Fisher Scoring iterations: 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>risk.mp0 <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="fu">predict</span>(risk.m0))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pm, resid_mt2, <span class="at">type=</span><span class="st">'p'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(pm, (risk.mp0), <span class="at">col=</span><span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/residual plot 1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>여기 또 다른 사망률 잔차와 PM10 잔차 간의 간단한 회귀 모델이 있습니다. 이게 맞나요?</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mt2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(death2 <span class="sc">~</span> x<span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span>event)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>resid_mt2 <span class="ot">&lt;-</span><span class="fu">resid</span>(mt2)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>pm2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(pm <span class="sc">~</span> x<span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>resid_pm2 <span class="ot">&lt;-</span><span class="fu">resid</span>(pm2)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>risk.m1<span class="ot">&lt;-</span><span class="fu">glm</span>(resid_mt2 <span class="sc">~</span> resid_pm2, <span class="at">family=</span>gaussian)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>risk.mp1 <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="fu">predict</span>(risk.m1))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(resid_pm2, resid_mt2, <span class="at">type=</span><span class="st">'p'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(resid_pm2, (risk.mp0), <span class="at">col=</span><span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/residual plot 2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>이것은 직관적인 그래프입니다. 시간 추세와 계절적 변동을 제거한 후 두 잔차 간의 관계를 보여줍니다.</p>
<section id="자기상관-autocorrelation" class="level4" data-number="4.3.0.1">
<h4 data-number="4.3.0.1" class="anchored" data-anchor-id="자기상관-autocorrelation"><span class="header-section-number">4.3.0.1</span> 자기상관 (Autocorrelation)</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">cbind</span>(<span class="st">'time'</span><span class="ot">=</span>x, pm,death2,event) <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
   time    pm death2 event
  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1     1  66.1    130     1
2     2  67.9    129     1
3     3  65.6    131     1
4     4  71.1    130     1
5     5  68.2    129     1
6     6  65.7    131     1</code></pre>
</div>
</div>
<p>자기상관(Autocorrelation)은 특정 시점의 관측값이 시간 지연(time lag)을 가진 다른 관측값과 얼마나 연관되어 있는지를 나타냅니다. 예를 들어, 주말은 7일의 자기상관을 가지며, 계절은 12개월의 자기상관을 가집니다.</p>
<p><span class="math display">\[ r(k) = \frac{1}{N} \sum_{t=1}^{N-k}
(x_{t} - \bar{x})(x_{t+k} - \bar{x})/c(0) \tag{2.1}  \]</span></p>
<p><span class="math display">\[ c(0) = \frac{1}{N} \sum_{t=1}^{N-k}(x_{t} - \bar{x})^2 \]</span></p>
<p>여기서:</p>
<ul>
<li><span class="math inline">\({r}(k)\)</span>: 시간 지연 k에서의 자기상관계수</li>
<li>N: 전체 관측값의 개수</li>
<li><span class="math inline">\({x}_{t}\)</span>: 시점 t에서의 관측값</li>
<li><span class="math inline">\(\bar{x}\)</span>: 관측값의 평균</li>
<li><span class="math inline">\(c(0)\)</span>: 분산</li>
</ul>
<p>자기상관 분석에서 가장 중요한 요소 중 하나는 계절성(seasonal factor)입니다. 따라서 계절성 요인을 제거하기 전과 후의 자기상관 함수(ACF) 플롯을 비교합니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#par(mflow)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">2</span>))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, death2, <span class="at">type=</span><span class="st">'p'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(dat<span class="sc">$</span>death2)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># adjusting seasonality</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>ar1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(death2 <span class="sc">~</span> x <span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span>event)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, death2, <span class="at">type=</span><span class="st">'p'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">predict</span>(ar1), <span class="at">col =</span> <span class="st">'red'</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(ar1))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># adjusting seasonality by gam model</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>ar2 <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(x,<span class="at">bs=</span><span class="st">"cc"</span>, <span class="at">k=</span><span class="dv">100</span>)<span class="sc">+</span>event, <span class="at">family=</span>gaussian)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, death2, <span class="at">type=</span><span class="st">'p'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">predict</span>(ar2), <span class="at">col =</span> <span class="st">'red'</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(ar2))</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(dat<span class="sc">$</span>death2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: dat$death2 
ARIMA(2,1,2) 

Coefficients:
         ar1      ar2      ma1     ma2
      0.6952  -0.4906  -0.8632  0.7667
s.e.  0.1099   0.1185   0.0810  0.0872

sigma^2 = 15.81:  log likelihood = -835.21
AIC=1680.42   AICc=1680.62   BIC=1698.92</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>m1<span class="ot">&lt;-</span><span class="fu">arima</span>(dat<span class="sc">$</span>death2, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, death2, <span class="at">type=</span><span class="st">'p'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(m1), <span class="at">col=</span><span class="st">"red"</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(m1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>자기상관을 제거하거나 제어하는 방법은 무엇이며, 어떤 모델이 더 적절할까요? 계절적 요인보다는 비계절적 요인의 변동에 따라 사망률이 변할 수 있다는 이야기를 하고 싶다면, 자기상관을 제어하거나 제거해야 합니다.</p>
<p>‘gam’ 모델을 사용하면 쉽고 효과적입니다. 그리고 <code>residual(death)</code>와 <code>residual(pm)</code> 사이의 관계를 살펴볼 것이라는 점을 기억합시다. 자유도(df)가 100인 큐빅 스플라인(cubic spline)의 GAM 모델이 있습니다. 두 모델의 요약 결과는 거의 동일하므로, mod1의 GAM 모델을 사용하여 두 잔차 사이의 관계를 찾을 수 있습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>time   <span class="ot">=</span> dat<span class="sc">$</span>time</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>mod1   <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> pm <span class="sc">+</span> <span class="fu">s</span>(time, <span class="at">bs=</span><span class="st">'cc'</span>, <span class="at">k=</span><span class="dv">100</span>))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>mod1 <span class="sc">%&gt;%</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
death2 ~ pm + s(time, bs = "cc", k = 100)

Parametric coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 105.38002    6.56030  16.063   &lt;2e-16 ***
pm           -0.13082    0.09704  -1.348    0.179    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
          edf Ref.df     F p-value    
s(time) 72.67     98 50.72  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.943   Deviance explained = 95.7%
GCV = 13.955  Scale est. = 10.482    n = 300</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>rpm    <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(pm <span class="sc">~</span> <span class="fu">s</span>(time, <span class="at">bs=</span><span class="st">'cc'</span>, <span class="at">k=</span><span class="dv">100</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>rdeath <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(time, <span class="at">bs=</span><span class="st">'cc'</span>, <span class="at">k=</span><span class="dv">100</span>))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>mod2   <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(<span class="fu">resid</span>(rdeath) <span class="sc">~</span> <span class="fu">resid</span>(rpm))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>mod2 <span class="sc">%&gt;%</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
resid(rdeath) ~ resid(rpm)

Parametric coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)  1.528e-14  1.626e-01   0.000    1.000
resid(rpm)  -1.036e-01  7.513e-02  -1.379    0.169


R-sq.(adj) =  0.00301   Deviance explained = 0.634%
GCV = 7.9884  Scale est. = 7.9352    n = 300</code></pre>
</div>
</div>
<p>지연 시간 효과(Lag time effect)는 또 다른 중요한 문제입니다. 지연 시간의 가정은 PM10 증가 시간으로부터 6일 후에 심혈관 질환 사망률이 증가한다는 것입니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(pm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 67.57556</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>lag.pm<span class="ot">&lt;-</span><span class="dv">6</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pm.lag <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fl">67.5</span>, lag.pm), pm[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(pm)<span class="sc">-</span>lag.pm)])</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>resid_mt3 <span class="ot">&lt;-</span><span class="fu">resid</span>(mt3)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>risk.m1<span class="ot">&lt;-</span><span class="fu">glm</span>(resid_mt3 <span class="sc">~</span> pm.lag, <span class="at">family=</span>gaussian)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(risk.m1)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate Std. Error   t value     Pr(&gt;|t|)
(Intercept) -76.437599 5.21757250 -14.65003 5.620794e-37
pm.lag        1.131554 0.07720006  14.65743 5.276143e-37</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>risk.mp1 <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="fu">predict</span>(risk.m1))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pm.lag, resid_mt3, <span class="at">type=</span><span class="st">'p'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(pm.lag, risk.mp1, <span class="at">col=</span><span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/lag time and plot and regression-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>PM10과 심혈관 질환 사망률 사이에 양의 연관성이 있습니다.</p>
<p>심혈관 질환과 PM10 사이의 지연 효과를 강조하는 플롯입니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, resid_mt3, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">15</span>, <span class="dv">40</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">300</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, (pm<span class="dv">-50</span>), <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.7</span>), <span class="at">type=</span><span class="st">"l"</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, (pm.lag<span class="dv">-60</span>), <span class="at">col=</span><span class="st">'red'</span>, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/fit plot 1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>sin()</code>을 사용하여 계절적 요인을 고려하고 <code>lag</code>를 사용하여 지연 효과를 고려하고 시계열 요인(잔차)을 제거한 후 PM과 심혈관 질환 사망 사이의 관계를 분석했습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages('mgcv')</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">#library(gam)</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>mgam<span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs=</span><span class="st">"cc"</span>, <span class="at">k=</span><span class="dv">100</span>)<span class="sc">+</span>event, <span class="at">family=</span>gaussian)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mgam)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, pm, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">150</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">300</span>), <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, death2, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.7</span>), <span class="at">type=</span><span class="st">"p"</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">250</span>, <span class="at">y=</span><span class="dv">70</span>, <span class="st">'PM10'</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">150</span>, <span class="at">y=</span><span class="dv">65</span>, <span class="st">'pm10. lag'</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">210</span>, <span class="at">y=</span><span class="dv">110</span>, <span class="st">'Obs_death'</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">10</span>, <span class="at">y=</span><span class="dv">50</span>, <span class="st">'Residual(Obs_Death - Gam(fitting)'</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, p)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, (<span class="fu">resid</span>(mgam)<span class="sc">+</span><span class="dv">50</span>), <span class="at">col=</span><span class="st">'blue'</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, pm.lag<span class="dv">-10</span>, <span class="at">col=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/ts summary plot 1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>회귀 분석으로 이 문제를 해결해 봅시다. k가 더 높을 때 모델은 어떻습니까? 예, 지연 시간과 k 값을 선택하는 방법을 고려해야 합니다. 데이터 기반 방법은 적합한 모델을 선택하는 일반적인 방법입니다. 최소 AIC 또는 BIC 값은 더 적합한 모델을 제시합니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>mgam<span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs=</span><span class="st">"cc"</span>, <span class="at">k=</span><span class="dv">100</span>)<span class="sc">+</span>event, <span class="at">family=</span>gaussian)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mgam)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>risk.pp1 <span class="ot">&lt;-</span><span class="fu">glm</span>(death2 <span class="sc">~</span> p<span class="sc">+</span>pm.lag,<span class="at">family=</span>gaussian)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(risk.pp1)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Estimate  Std. Error   t value     Pr(&gt;|t|)
(Intercept) -58.3872771 1.937186312 -30.14025 2.402418e-92
p             1.0000436 0.004566766 218.98286 0.000000e+00
pm.lag        0.8642815 0.028266084  30.57663 9.482839e-94</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(risk.pp1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 885.3135</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>mgam150<span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs=</span><span class="st">"cc"</span>, <span class="at">k=</span><span class="dv">10</span>)<span class="sc">+</span>event)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>p150 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mgam150)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>risk.pp150 <span class="ot">&lt;-</span><span class="fu">glm</span>(death2 <span class="sc">~</span> p150<span class="sc">+</span> pm.lag, <span class="at">family=</span>gaussian)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(risk.pp150)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Estimate Std. Error   t value      Pr(&gt;|t|)
(Intercept) -72.5953393 6.74682944 -10.75992  5.109224e-23
p150          0.9979243 0.01630871  61.18966 2.087420e-170
pm.lag        1.0776412 0.09754736  11.04736  5.349868e-24</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(risk.pp1, risk.pp150)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           df       AIC
risk.pp1    4  885.3135
risk.pp150  4 1629.2747</code></pre>
</div>
</div>
<p>dlnm 패키지(분산 지연 비선형 모델)를 사용하여 지연 시간을 찾아봅시다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dlnm)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>cb1.pm <span class="ot">&lt;-</span><span class="fu">crossbasis</span>(pm, <span class="at">lag=</span><span class="dv">10</span>, <span class="at">argvar=</span><span class="fu">list</span>(<span class="at">fun=</span><span class="st">"lin"</span>),</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">arglag=</span><span class="fu">list</span>(<span class="at">fun=</span><span class="st">"poly"</span>, <span class="at">degree=</span><span class="dv">3</span>))</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span><span class="fu">glm</span>(death2 <span class="sc">~</span> cb1.pm<span class="sc">+</span>x<span class="sc">+</span>event , </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">family=</span>gaussian )</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>pred1.pm <span class="ot">&lt;-</span><span class="fu">crosspred</span>(cb1.pm, model1, <span class="at">at=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">bylag=</span><span class="fl">0.1</span>, <span class="at">cumul=</span><span class="cn">TRUE</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred1.pm, <span class="st">"slices"</span>, <span class="at">var=</span><span class="dv">1</span>, <span class="at">col=</span><span class="dv">3</span>, <span class="at">ylab=</span><span class="st">"RR"</span>, <span class="at">ci.arg=</span><span class="fu">list</span>(<span class="at">density=</span><span class="dv">15</span>,<span class="at">lwd=</span><span class="dv">2</span>),</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>     <span class="co">#cumul = TRUE,</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="at">main=</span><span class="st">"Association with a 1-unit increase in PM10"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/dlnm plot 1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><span class="math inline">\(\beta\)</span>는 6일 지연에서 가장 높습니다.</p>
<p>이제 6일을 지연 시간으로 사용하여 회귀 분석을 수행할 수 있다는 것을 알았습니다. 남은 것은 시계열 요소를 찾고, 수정하고, 이 과정을 합리화하는 방법에 대해 더 논의하는 것입니다.</p>
</section>
</section>
<section id="사례-연구-독감과-자살" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="사례-연구-독감과-자살"><span class="header-section-number">4.4</span> 사례 연구 : 독감과 자살</h2>
<p>이번에는 독감 유행과 자살에 대해 이야기해 보겠습니다. 몇 년 전 일본에서 독감 치료 중 자살이 뉴스에 나왔는데, 독감이 주로 유행하는 계절적 요인의 문제인지, 아니면 독감 유행이 정말 심할 때 자살이 발생하는 것인지 분석해 보고자 합니다.</p>
<section id="실습-데이터" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="실습-데이터"><span class="header-section-number">4.4.1</span> 실습 데이터</h3>
<p>첫번째 실습 데이터는 감염병 포탈의 인플루엔자 자료입니다. 여기서 다운로드 합니다.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/influenza1.png" class="img-fluid figure-img"></p>
<figcaption>인플루엔자</figcaption>
</figure>
</div>
<p>두번째 실습 자료는 통계청 사망자료 입니다.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/influenza2.png" class="img-fluid figure-img"></p>
<figcaption>인플루엔자</figcaption>
</figure>
</div>
<p>이 둘을 합해 놓은 자료는 아래에 있습니다.</p>
<p>이것을 data 폴더에 넣겠습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/jinhaslab/opendata/main/data/flu_suicide0.csv"</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(url, <span class="st">"data/flu_suicide0.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(tidyverse)) <span class="fu">install.packages</span>(<span class="st">'tidyverse'</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(lubridate)) <span class="fu">install.packages</span>(<span class="st">'lubridate'</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(mgcv)) <span class="fu">install.packages</span>(<span class="st">'mgcv'</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(dlnm)) <span class="fu">install.packages</span>(<span class="st">'dlnm'</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(gam)) <span class="fu">install.packages</span>(<span class="st">'gam'</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(forecast)) <span class="fu">install.packages</span>(<span class="st">'forecast'</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(Hmisc)) <span class="fu">install.packages</span>(<span class="st">'Hmisc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>데이터를 살펴보면 ymd 는 숫자 형식의 날짜 (기준 1970년 1월 1일), <code>wsui</code> 는 1주간의 자살 사망자 수, <code>ordweek</code> 는 주중 순위, <code>flu</code> 는 주중 천명당 인플루엔자 환자 수.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>data0 <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/flu_suicide0.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 696 Columns: 9
── Column specification
────────────────────────────────────────────────────────
Delimiter: "," dbl (8): ...1, ymd, wsui, ordweek, nwd, YR, flu, flu2 date (1):
ymd2
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
Specify the column types or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
   ...1   ymd  wsui ordweek ymd2         nwd    YR   flu  flu2
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1    35 12660   238      35 2004-08-30    36  2004   0.6   0.6
2    36 12667   211      36 2004-09-06    37  2004   2     2  
3    37 12674   208      37 2004-09-13    38  2004   2.1   2.1
4    38 12681   188      38 2004-09-20    39  2004   2.2   2.2
5    39 12688   213      39 2004-09-27    40  2004   2.5   2.5
6    40 12695   224      40 2004-10-04    41  2004   2.4   2.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data0<span class="sc">$</span>wsui)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>신종 플루가 2009년부터 유행했고, 이후 자살자가 관련있다는 뉴스가 나오고 있으니, 2009년 전과 후를 나타내는 변수를 만들겠습니다 .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>myd<span class="ot">&lt;-</span>data0 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Change=</span><span class="fu">ifelse</span>(YR<span class="sc">&gt;</span><span class="dv">2008</span>, <span class="st">"from 2009"</span>, <span class="st">"before 2009"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>자료가 시계열 자료라는 것을 컴퓨터에게 알려줄 필요가 있습니다. 그리고 싸이클이 있다는 것도요. 우리는 주당 싸이클 (7일 기준)이기 때문에 <code>frequency=365.25/7</code>을 이용하고 시작 날짜를 정해줍니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>tsui <span class="ot">&lt;-</span><span class="fu">ts</span>(myd<span class="sc">$</span>wsui, <span class="at">frequency=</span><span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span>, <span class="at">start =</span> <span class="fu">decimal_date</span>(<span class="fu">ymd</span>(<span class="st">"2004-08-30"</span>)))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(myd<span class="sc">$</span>wsui)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 696</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(tsui)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 696</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tsui)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/first ts 1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>여기서 시계열적 요소를 찾아 보겠습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>d.tsui <span class="ot">&lt;-</span><span class="fu">decompose</span>(tsui)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co">#d.tsui</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d.tsui) <span class="do">####### find seasonal and trend</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/decomposition ts 1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(d.tsui<span class="sc">$</span>random)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.     NA's 
-78.1819 -18.8440  -0.3562   1.2124  18.5710 175.0412       51 </code></pre>
</div>
</div>
<p>이번에는 flu에 대한 시계열 분석을 해보겠습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>r.tsui <span class="ot">&lt;-</span>d.tsui<span class="sc">$</span>random <span class="co"># residuals</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>s.tsui <span class="ot">&lt;-</span>d.tsui<span class="sc">$</span>seasonal <span class="co"># seasonal</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>tr.tsui <span class="ot">&lt;-</span>d.tsui<span class="sc">$</span>trend <span class="co"># long term trend</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="do">######### influenza'</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>tflu <span class="ot">&lt;-</span><span class="fu">ts</span>(myd<span class="sc">$</span>flu, <span class="at">frequency=</span><span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span>, <span class="at">start =</span> <span class="fu">decimal_date</span>(<span class="fu">ymd</span>(<span class="st">"2004-08-30"</span>)))</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tflu)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>이것을 decomposition 하면</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>d.tflu <span class="ot">&lt;-</span><span class="fu">decompose</span>(tflu)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d.tflu) <span class="do">####### find seasonal and trend</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>r.tflu <span class="ot">&lt;-</span>d.tflu<span class="sc">$</span>random <span class="co"># residuals</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>s.tflu <span class="ot">&lt;-</span>d.tflu<span class="sc">$</span>seasonal <span class="co"># seasonal</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>tr.tflu <span class="ot">&lt;-</span>d.tflu<span class="sc">$</span>trend <span class="co"># long term trend</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simple-time-related-variable-adjusting-regression" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="simple-time-related-variable-adjusting-regression"><span class="header-section-number">4.4.2</span> simple time-related variable adjusting regression</h3>
<p>결국 resudial flu와 residual sui의 상관관계를 보면 되는 것이라고 생각해 봅시다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Hmisc)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r.tflu, r.tsui)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> r.tflu))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/nolagmodel-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>), r.tsui)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/nolagmodel-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r.tflu, r.tsui, <span class="at">cex=</span><span class="fl">0.2</span>, <span class="at">main=</span><span class="st">"no lag model"</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> r.tflu))</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">15</span>, <span class="dv">130</span>, <span class="st">'Beta ='</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">15</span>, <span class="dv">100</span>, <span class="st">'P value='</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">30</span>, <span class="dv">130</span>, <span class="fu">round</span>(<span class="fu">summary</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">0</span>)))<span class="sc">$</span>coefficients[<span class="fu">c</span>(<span class="dv">2</span>)], <span class="dv">4</span>))</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">30</span>, <span class="dv">100</span>, <span class="fu">round</span>(<span class="fu">summary</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">0</span>)))<span class="sc">$</span>coefficients[<span class="fu">c</span>(<span class="dv">8</span>)], <span class="dv">4</span>))</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>), r.tsui, <span class="at">cex=</span><span class="fl">0.2</span>, <span class="at">main=</span><span class="st">"3 weeks lag model"</span>)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>)))</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">15</span>, <span class="dv">130</span>, <span class="st">'Beta ='</span>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">15</span>, <span class="dv">100</span>, <span class="st">'P value='</span>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">30</span>, <span class="dv">130</span>, <span class="fu">round</span>(<span class="fu">summary</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>)))<span class="sc">$</span>coefficients[<span class="fu">c</span>(<span class="dv">2</span>)], <span class="dv">3</span>))</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">30</span>, <span class="dv">100</span>, <span class="fu">round</span>(<span class="fu">summary</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>)))<span class="sc">$</span>coefficients[<span class="fu">c</span>(<span class="dv">8</span>)], <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="arima" class="level3" data-number="4.4.3">
<h3 data-number="4.4.3" class="anchored" data-anchor-id="arima"><span class="header-section-number">4.4.3</span> ARIMA</h3>
<p>ARIMA 및 시계열 분석 이 과정에서 다룰 수 있는 내용은 다음과 같습니다.</p>
<ul>
<li>날짜 및 시간 형식 지정</li>
<li>데이터 전처리 (ts 클래스, 데이터 정리, 결측치 처리, 이상치 처리)</li>
<li>시계열의 통계적 특징 (자기상관, 정상성, 계절성, 추세)</li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">단계</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">날짜 및 시간 형식 지정</td>
</tr>
<tr class="even">
<td style="text-align: left;">데이터 전처리</td>
</tr>
<tr class="odd">
<td style="text-align: left;">시계열의 통계적 특징</td>
</tr>
<tr class="even">
<td style="text-align: left;">표준 모델</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ARIMA 모델</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="분석-및-예측-회귀-분석" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="분석-및-예측-회귀-분석"><span class="header-section-number">4.5</span> 분석 및 예측, 회귀 분석</h2>
<p>시계열 분석은 패턴을 찾기 위해 데이터를 분석하는 것이고, 예측은 그 패턴을 미래로 확장하는 것입니다. 시계열 패턴을 이용한 회귀 분석(시계열 회귀 분석)은 시계열 분석을 사용하는 회귀 방법입니다.</p>
</section>
<section id="arima-1" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="arima-1"><span class="header-section-number">4.6</span> ARIMA</h2>
<p>ARIMA(자기회귀 통합 이동 평균, Autoregressive Integrated Moving Average)는 문자 그대로 자기회귀와 이동 평균을 이용합니다. 단변량 시계열(univariate time series)로 볼 수 있습니다. ARIMA 모델에서는 여러 매개변수를 자동으로 또는 수동으로 설정하여 구성합니다.</p>
<p><strong><code>ARIMA(p, d, q)</code></strong>를 이해하면서 가 봅겠습니다. <br></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">parameter</th>
<th style="text-align: left;">content</th>
<th style="text-align: left;">abbr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">AR</td>
<td style="text-align: left;">Autoregressive part</td>
<td style="text-align: left;"><strong>p</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">Integrateion, degree of differencing</td>
<td style="text-align: left;"><strong>d</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left;">MA</td>
<td style="text-align: left;">Moving average part</td>
<td style="text-align: left;"><strong>q</strong></td>
</tr>
</tbody>
</table>
<p>위 에서 <code>p, d, q</code>를 찾아 가는 방법을 ARIMA 모델이라고 부를 수 있습니다.</p>
<blockquote class="blockquote">
<p>lags 과 forecasting errors로 구분할 수 있습니다.</p>
</blockquote>
<ul>
<li>과거의 변수가 현재를 예측, autoregressive part
<ul>
<li>AR(1) or ARIMA(1,0,0): first order (lag) of AR</li>
<li>AR(2) or ARIMA(2,0,0): second order (lag) of AR <br></li>
</ul></li>
<li>과거의 error 가 현재를 예측 (forecasting error) = moving average part
<ul>
<li>MA(1) or ARIMA(0,0,1): first order of MA</li>
<li>MA(2) or ARIMA(0,0,2): second order of MA</li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>자기상관관계 부분</p>
</blockquote>
<p><span class="math display">\[ Y_{t} = c + \Phi_1 Y_{t-1} + \varepsilon_{t} \]</span></p>
<ul>
<li><span class="math inline">\(t\)</span> 시간에 관찰되는 변수 (<span class="math inline">\(Y_{t}\)</span>)는
<ul>
<li>상수 (c) 더하기</li>
<li>바로 1단위 전 변수 (<span class="math inline">\(Y_{t-1}\)</span>) 에 계수(coefficient) (<span class="math inline">\(\Phi\)</span>) 글 곱한 값을 더하고</li>
<li>현재의 에러를 <span class="math inline">\(t (e_{t})\)</span>) 더한다</li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>이동평균 부분</p>
</blockquote>
<p><span class="math display">\[ Y_{t} = c  + \Theta_1 \varepsilon_{t-1} + \varepsilon_t \]</span></p>
<ul>
<li><span class="math inline">\(t\)</span> 시간에 관찰되는 변수 (<span class="math inline">\(Y_{t}\)</span>)는
<ul>
<li>상수 (c) 더하기</li>
<li>바로 1단위 전 변수 (<span class="math inline">\(\varepsilon_{t-1}\)</span>) 에 계수(coefficient) (<span class="math inline">\(\Phi\)</span>) 글 곱한 값을 더하고</li>
<li>현재의 에러를 <span class="math inline">\(t (e_{t})\)</span>) 더한다</li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>결국 자기 상과관계와 이동평균을 한꺼번에 사용하면 아래와 같습니다.</p>
</blockquote>
<p><span class="math display">\[\begin{align*}
y_t &amp;= \phi_1y_{t-1} + \varepsilon_t\\
&amp;= \phi_1(\phi_1y_{t-2} + \varepsilon_{t-1}) + \varepsilon_t\\
&amp;= \phi_1^2y_{t-2} + \phi_1 \varepsilon_{t-1} + \varepsilon_t\\
&amp;= \phi_1^3y_{t-3} + \phi_1^2 \varepsilon_{t-2} + \phi_1 \varepsilon_{t-1} + \varepsilon_t\\
\end{align*}\]</span></p>
<blockquote class="blockquote">
<p>d 는 시계열그림에서 ACF, PACF의 형태를 보고 차분의 필요여부 및 차수를 d를 결정하고 AR차수와 MA차수를 결정</p>
</blockquote>
<p>어떻게 <strong>p, d, q</strong> 를 구할수 있을 까요?, 다음 장을 보겠습니다. ** 다음에 기회가 있을 때 하겠습니다.**</p>
<section id="arima-감기-자살-aic" class="level3" data-number="4.6.1">
<h3 data-number="4.6.1" class="anchored" data-anchor-id="arima-감기-자살-aic"><span class="header-section-number">4.6.1</span> arima 감기 자살 , AIC</h3>
<p>아래 ARIMA 모델을 보면 AIC 가 6583정도 나온 것을 알 수 있습니다. 우리는 이것을 통해 AIC가 6583 이하 정도 나오는 gam 모델을 사용하겠다 정도의 개념을 얻었습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(myd<span class="sc">$</span>wsui)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: myd$wsui 
ARIMA(0,1,2) 

Coefficients:
          ma1      ma2
      -0.3227  -0.0993
s.e.   0.0379   0.0376

sigma^2 = 756.3:  log likelihood = -3288.64
AIC=6583.28   AICc=6583.31   BIC=6596.91</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>myd <span class="ot">&lt;-</span>myd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ma4 =</span><span class="fu">ma</span>(wsui, <span class="at">order=</span><span class="dv">4</span>), <span class="at">ymd2=</span><span class="fu">as.Date</span>(ymd2) ) <span class="do">### 4weeks moving average</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>myd <span class="ot">&lt;-</span>myd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ts.wsui =</span>tsui, <span class="at">ts.ma4=</span><span class="fu">ts</span>(ma4, <span class="at">frequency =</span><span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span> ))</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>m1<span class="ot">&lt;-</span><span class="fu">arima</span>(myd<span class="sc">$</span>wsui, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">fixed=</span><span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)) <span class="do">## NA means include, 0 means exclude</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>m1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
arima(x = myd$wsui, order = c(1, 1, 1), fixed = c(NA, NA))

Coefficients:
         ar1      ma1
      0.2294  -0.5589
s.e.  0.0941   0.0797

sigma^2 estimated as 755.2:  log likelihood = -3289.13,  aic = 6584.26</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tsdiag</span>(m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="aic-bic-in-generalize-additive-model" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="aic-bic-in-generalize-additive-model"><span class="header-section-number">4.7</span> AIC BIC in generalize additive model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">ns</span>(ymd2, x))</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  aic <span class="ot">&lt;-</span><span class="fu">AIC</span>(model)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aic)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>gg2 <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">ns</span>(ymd2, x))</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  bic <span class="ot">&lt;-</span><span class="fu">BIC</span>(model)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bic)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>), gg);test2<span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>), gg2)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>), test);<span class="fu">plot</span>(<span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>), test2)</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">64</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>AIC는 수렴하지 않아 어렵고, BIC는 64에서 최소 값을 보이네요. 64를 자유도로 선정하고 수행하겠습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>mod1<span class="ot">&lt;-</span><span class="fu">glm</span> (wsui <span class="sc">~</span> <span class="fu">ns</span>(ymd2, <span class="dv">64</span>), <span class="at">data=</span>myd)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6790.573</code></pre>
</div>
</div>
<p>long term trend (월)과 단기 trend 를 나누어 만들어 보면 어떨까요? 위에 64로 한번에 해결하는 게 더 좋은 모형 같습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>mod1<span class="ot">&lt;-</span><span class="fu">glm</span>( wsui <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">12</span>)<span class="sc">+</span><span class="fu">ns</span>(nwd, <span class="dv">5</span>), <span class="at">data=</span>myd)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6907.866</code></pre>
</div>
</div>
<p>기존의 sin cosin 방법으로 시계열 분석을 해보는 것은 어떨까요?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>ssp<span class="ot">&lt;-</span><span class="fu">spectrum</span>(myd<span class="sc">$</span>wsui)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>per<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">/</span>ssp<span class="sc">$</span>freq[ssp<span class="sc">$</span>spec<span class="sc">==</span><span class="fu">max</span>(ssp<span class="sc">$</span>spec)]</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>sin.x<span class="ot">&lt;-</span><span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>myd<span class="sc">$</span>ordweek<span class="sc">/</span>(<span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span>))</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>cos.x<span class="ot">&lt;-</span><span class="fu">cos</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>myd<span class="sc">$</span>ordweek<span class="sc">/</span>(<span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span>))</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>modsean <span class="ot">&lt;-</span><span class="fu">glm</span>(wsui <span class="sc">~</span> <span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>), <span class="at">data=</span>myd)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>modlgam<span class="ot">&lt;-</span><span class="fu">glm</span>(wsui <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">4</span>), <span class="at">data=</span>myd)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myd<span class="sc">$</span>ymd2, myd<span class="sc">$</span>wsui, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">450</span>), <span class="at">col=</span><span class="st">'grey'</span>)</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modlgam<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>)</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modsean<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/unnamed-chunk-20-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>자 이제 2 모델을 검토해 보겠습니다. gam 과 sin cosin 모델 어떤게 더 좋아 보이시나요? 정해진 규칙은 겂습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myd<span class="sc">$</span>ymd2, myd<span class="sc">$</span>wsui, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">450</span>), <span class="at">col=</span><span class="st">'grey'</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modlgam<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modsean<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span><span class="fu">glm</span>(wsui <span class="sc">~</span> flu<span class="sc">+</span><span class="fu">ns</span>(ordweek, <span class="dv">51</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>) , <span class="at">data=</span>myd)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, mod1<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>modgam<span class="ot">&lt;-</span><span class="fu">glm</span> (wsui <span class="sc">~</span> <span class="fu">ns</span>(ymd2, <span class="dv">64</span>), <span class="at">data=</span>myd)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modgam<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">'l'</span>,  <span class="at">col=</span><span class="st">'black'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/comp1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>정해진 규칙은 없지만 AIC와 BIC로 비교해 볼수 있을 것 같습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(mod1);<span class="fu">AIC</span>(modgam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6522.708</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6490.58</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(mod1);<span class="fu">BIC</span>(modgam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6786.338</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6790.573</code></pre>
</div>
</div>
<p>이제 sin과 cos 에 어떠한 df를 주는 것이 좋을 까요?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>myd<span class="sc">$</span>econo <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(myd<span class="sc">$</span>YR <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2009</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">Lag</span>(flu, <span class="dv">1</span>)<span class="sc">+</span><span class="fu">ns</span>(ordweek, <span class="dv">4</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, x)<span class="sc">+</span><span class="fu">ns</span>(cos.x, x))</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  aic <span class="ot">&lt;-</span><span class="fu">AIC</span>(model)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aic)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">Lag</span>(flu, <span class="dv">1</span>)<span class="sc">+</span><span class="fu">ns</span>(ordweek, <span class="dv">4</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, x)<span class="sc">+</span><span class="fu">ns</span>(cos.x, x))</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  bic <span class="ot">&lt;-</span><span class="fu">BIC</span>(model)</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bic)</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>p<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span>p, gg);test2<span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span>p, gg2)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/comp2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/comp2-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>주중 효과 까지 한번 보겠습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">Lag</span>(flu, <span class="dv">1</span>)<span class="sc">+</span> <span class="fu">ns</span>(ordweek, x)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  aic <span class="ot">&lt;-</span><span class="fu">AIC</span>(model)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aic)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>gg2 <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">Lag</span>(flu, <span class="dv">1</span>)<span class="sc">+</span><span class="fu">ns</span>(ordweek, x)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  bic <span class="ot">&lt;-</span><span class="fu">BIC</span>(model)</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bic)</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="fu">gg</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6854.818</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 7024.330 6937.360 6937.973 6949.360 6961.920 6963.986 6982.745 6988.485
 [9] 6998.475 7012.750</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>p<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">100</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span>p, gg);test2<span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span>p, gg2)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">39</span>)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test2)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">39</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/mod4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>최종 모델은 아래와 같습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> flu<span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">39</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myd<span class="sc">$</span>ymd2, myd<span class="sc">$</span>wsui, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">col=</span><span class="st">'grey'</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">50</span>, <span class="dv">450</span>))</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, mod2<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/mod5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6785.128</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6576.042</code></pre>
</div>
</div>
<p>그럼 이제 lag time 을 non-linear 로 할때 몇차 방정식이 좋을까요? 둘다 2차 방정식이 좋네요</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>gg3<span class="ot">&lt;-</span><span class="cf">function</span>(pp){</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  cb<span class="ot">&lt;-</span> <span class="fu">crossbasis</span>(myd<span class="sc">$</span>flu<span class="sc">/</span><span class="dv">10</span>, <span class="at">lag=</span><span class="dv">24</span>, <span class="at">argvar=</span><span class="fu">list</span>(<span class="st">"lin"</span>),  <span class="at">arglag =</span> <span class="fu">list</span>(<span class="at">fun=</span><span class="st">"poly"</span>, <span class="at">degree=</span>pp))</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  model<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> cb <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">39</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  aic<span class="ot">&lt;-</span><span class="fu">AIC</span>(model)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aic)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>gg4<span class="ot">&lt;-</span><span class="cf">function</span>(pp){</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  cb1<span class="ot">&lt;-</span> <span class="fu">crossbasis</span>(myd<span class="sc">$</span>flu<span class="sc">/</span><span class="dv">10</span>, <span class="at">lag=</span><span class="dv">24</span>, <span class="at">argvar=</span><span class="fu">list</span>(<span class="st">"lin"</span>),  <span class="at">arglag =</span> <span class="fu">list</span>(<span class="at">fun=</span><span class="st">"poly"</span>, <span class="at">degree=</span>pp))</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  model1<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> cb1 <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">39</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  bic<span class="ot">&lt;-</span><span class="fu">BIC</span>(model1)</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bic)</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>p<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>test3 <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">pp=</span>p, gg3);test4 <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">pp=</span>p, gg4)</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test3)</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/ts simul lag-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>종합해서 나타내 보겠습니다. 이것이 첫번째 종착지 입니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>cb1<span class="ot">&lt;-</span> <span class="fu">crossbasis</span>(myd<span class="sc">$</span>flu<span class="sc">/</span><span class="dv">10</span>, <span class="at">lag=</span><span class="dv">24</span>, <span class="at">argvar=</span><span class="fu">list</span>(<span class="st">"lin"</span>),  <span class="at">arglag =</span> <span class="fu">list</span>(<span class="at">fun=</span><span class="st">"poly"</span>, <span class="at">degree=</span><span class="dv">2</span>))</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>model1<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> cb1 <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">39</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>pred1.cb1 <span class="ot">&lt;-</span><span class="fu">crosspred</span>(cb1, model1, <span class="at">at=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">bylag=</span><span class="fl">0.1</span>,  <span class="at">cumul=</span><span class="cn">TRUE</span>)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred1.cb1, <span class="st">"slices"</span>, <span class="at">var=</span><span class="dv">1</span>, <span class="at">col=</span><span class="dv">3</span>, <span class="at">ylab=</span><span class="st">"Relative risk of suicide"</span>, <span class="co">#ci.arg=list(density=50, lwd=1),#</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"Temporal effect by influenza"</span>, </span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Lag (weeks)"</span>,  <span class="co">#ylim=c(0.980, 1.02),</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span><span class="st">'black'</span>) ;<span class="fu">grid</span>()</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main=</span><span class="st">"% increment of influenza like illness"</span>, </span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">adj=</span><span class="dv">1</span>, <span class="at">line=</span><span class="dv">0</span>, <span class="at">font.main=</span><span class="dv">3</span>, <span class="at">cex=</span><span class="fl">0.5</span> )</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>lin <span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>lin, <span class="at">lty=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">'lightgray'</span>)</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">1</span>, <span class="at">at=</span><span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/ts regression 1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>2009년 이전과 이후를 그려보겠습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>myd2<span class="ot">&lt;-</span>myd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sinx=</span>sin.x, <span class="at">cosx=</span>cos.x) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">flu210=</span>flu<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>mf1d <span class="ot">&lt;-</span>myd2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(YR <span class="sc">&lt;=</span><span class="dv">2008</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>mf2d <span class="ot">&lt;-</span>myd2 <span class="sc">%&gt;%</span> <span class="fu">filter</span> (YR<span class="sc">&gt;=</span><span class="dv">2009</span>)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>mf1 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf1d, wsui <span class="sc">~</span> flu <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">25</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx, <span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>mf1s<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf1d , flu210 <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">25</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx,<span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>b2008<span class="ot">&lt;-</span><span class="fu">summary</span>(mf1)<span class="sc">$</span>coefficient[<span class="dv">2</span>,]</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>mf2 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf2d, wsui <span class="sc">~</span> flu <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">22</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx, <span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>mf2s <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf2d, flu210 <span class="sc">~</span><span class="fu">ns</span>(ordweek, <span class="dv">25</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx,<span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>f2008<span class="ot">&lt;-</span><span class="fu">summary</span>(mf2)<span class="sc">$</span>coefficient[<span class="dv">2</span>,]</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>mfresid<span class="ot">&lt;-</span><span class="fu">c</span>(mf1<span class="sc">$</span>residuals, mf2<span class="sc">$</span>residuals)</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>Ch <span class="ot">&lt;-</span><span class="fu">c</span>(myd2<span class="sc">$</span>Change_2008)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Unknown or uninitialised column: `Change_2008`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">#exp(cbind("Relative Risk"=coef(mf2), confint.default(mf2, level = 0.95)))</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co">#exp(cbind("Relative Risk"=coef(mf1), confint.default(mf1, level = 0.95)))</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co"># E(Y) = intercept + B1X1 +gam(others)</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co"># E(Y)- intercept - B1X1 = gam(otehrs)</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>gamothers1 <span class="ot">&lt;-</span> mf1<span class="sc">$</span>fitted.values <span class="sc">-</span> <span class="fl">0.943684</span> <span class="sc">-</span>(<span class="sc">-</span><span class="fl">0.013931</span>) <span class="sc">*</span>mf1d<span class="sc">$</span>flu210</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>gamothers2 <span class="ot">&lt;-</span> mf2<span class="sc">$</span>fitted.values <span class="sc">-</span> <span class="fl">0.8892468</span> <span class="sc">-</span>(<span class="fl">0.0023323696</span>) <span class="sc">*</span>mf2d<span class="sc">$</span>flu210</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co"># E(Y)- intercept - gam(others)= B1X1  </span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Hence Y axis = E(Y)- intercept - gam(others)</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>Yaxis.mf1d <span class="ot">&lt;-</span> mf1<span class="sc">$</span>fitted.values <span class="sc">-</span>(<span class="fl">0.943684</span>) <span class="sc">-</span> gamothers1</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>Yaxis.mf2d <span class="ot">&lt;-</span> mf2<span class="sc">$</span>fitted.values <span class="sc">-</span>(<span class="fl">0.8892468</span>) <span class="sc">-</span> gamothers2</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>mf1d<span class="sc">$</span>Yaxis.mf <span class="ot">&lt;-</span>Yaxis.mf1d</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>mf2d<span class="sc">$</span>Yaxis.mf <span class="ot">&lt;-</span>Yaxis.mf2d</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mf1d<span class="sc">$</span>flu210, Yaxis.mf1d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/ts fig 3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mf2d<span class="sc">$</span>flu210, Yaxis.mf2d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/ts fig 3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myd2<span class="sc">$</span>flu210<span class="sc">*</span><span class="dv">10</span>, myd2<span class="sc">$</span>wsui)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/ts fig 3-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(glm(Yaxis.mf1d ~ mf1d$flu210))</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(glm(Yaxis.mf2d ~ mf2d$flu210))</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>tt <span class="ot">&lt;-</span><span class="fu">c</span>(mf1d<span class="sc">$</span>Yaxis.mf, mf2d<span class="sc">$</span>Yaxis.mf)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>tt2<span class="ot">&lt;-</span><span class="fu">c</span>(mf1<span class="sc">$</span>fitted.values, mf2<span class="sc">$</span>fitted.values)</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>myd2 <span class="ot">&lt;-</span>myd2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Yaxis.mf =</span>tt, <span class="at">mfresid =</span>mfresid, <span class="at">mf.fit=</span>tt2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>2009년 이후로 좀더 사망하게 되네요.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>f3<span class="ot">&lt;-</span><span class="fu">ggplot</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(flu210, Yaxis.mf, <span class="at">col=</span>Change))<span class="sc">+</span><span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(flu210, Yaxis.mf, <span class="at">shape=</span>Change), <span class="at">size=</span><span class="fl">0.0</span>)<span class="sc">+</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size=</span><span class="dv">14</span>,<span class="at">base_family=</span><span class="st">'Times New Roman'</span>)<span class="sc">+</span> </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>))<span class="sc">+</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Influenza"</span>) <span class="sc">+</span><span class="fu">ylab</span>(<span class="st">"Increment of Suicide"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>fig3 <span class="ot">&lt;-</span>f3 <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(flu210, mfresid, <span class="at">shape=</span>Change), <span class="at">size=</span><span class="dv">3</span> ) <span class="sc">+</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>))<span class="sc">+</span> <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">'red'</span>, <span class="st">'grey45'</span>))<span class="sc">+</span> </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Linear relationship between Influenza and Suicide"</span>,</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle=</span><span class="st">"Beta = -0.066, p = 0.214  before 2009</span><span class="sc">\n</span><span class="st">  *RR =  0.013,  p = 0.018     from 2009"</span>) <span class="sc">+</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">plot.subtitle=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>, <span class="at">hjust=</span><span class="dv">1</span>, <span class="at">face=</span><span class="st">"italic"</span>, <span class="at">color=</span><span class="st">"black"</span>)) <span class="sc">+</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> <span class="st">'log'</span>)</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>fig3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in scale_x_continuous(trans = "log"): log-2.718282 transformation
introduced infinite values.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in scale_x_continuous(trans = "log"): log-2.718282 transformation introduced infinite values.
log-2.718282 transformation introduced infinite values.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/ts fig1.1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>지금까지의 내용을 정리해 보겠습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>mf11 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf1d , wsui <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">25</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx,<span class="dv">2</span>))</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>mf12 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf2d, wsui <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">22</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx, <span class="dv">2</span>))</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>tt3<span class="ot">&lt;-</span><span class="fu">c</span>(mf11<span class="sc">$</span>residuals, mf12<span class="sc">$</span>residuals)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>myd2<span class="ot">&lt;-</span>myd2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">f3resid=</span>tt3) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Period=</span>Change)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>f1<span class="ot">&lt;-</span><span class="fu">ggplot</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2, wsui, <span class="at">shape=</span>Change), <span class="at">size=</span><span class="fl">0.3</span>)<span class="sc">+</span> <span class="fu">scale_shape_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">19</span>), <span class="at">name=</span><span class="st">""</span>)<span class="sc">+</span> </span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2, wsui, <span class="at">shape=</span>Change))<span class="sc">+</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#geom_point(aes(x=ymd2, y=f3resid, col=Change)) +</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2, mod2<span class="sc">$</span>fitted.values, <span class="at">linetype=</span><span class="st">"A"</span>, <span class="at">color=</span><span class="st">'A'</span>))<span class="sc">+</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2,flu210<span class="sc">*</span><span class="dv">20</span>, <span class="at">linetype=</span><span class="st">"B"</span>, <span class="at">color=</span><span class="st">'B'</span>))<span class="sc">+</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2, f3resid, <span class="at">linetype=</span><span class="st">"C"</span>, <span class="at">color=</span><span class="st">'C'</span>))<span class="sc">+</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="at">A=</span><span class="st">"dotted"</span>, <span class="at">B=</span><span class="st">"solid"</span>, <span class="at">C=</span><span class="st">"dashed"</span>), </span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Suicide (Crude)"</span>, <span class="st">"Influenza like illness"</span>, <span class="st">"Suicide </span><span class="sc">\n</span><span class="st">(Time series adjusted)"</span>), </span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>                        <span class="at">name=</span><span class="st">"Suicide and Influenza"</span>)<span class="sc">+</span> </span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="at">A=</span><span class="st">"black"</span>, <span class="at">B=</span><span class="st">"blue"</span>, <span class="at">C=</span><span class="st">"red"</span>), </span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Suicide (Crude)"</span>, <span class="st">"Influenza like illness"</span>, <span class="st">"Suicide </span><span class="sc">\n</span><span class="st">(Time series adjusted)"</span>), </span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>                        <span class="at">name=</span><span class="st">"Suicide and Influenza"</span>)<span class="sc">+</span> </span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>                                                              <span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>                                                              <span class="at">axis.text.y=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Years (unit=weeks)"</span>) <span class="sc">+</span><span class="fu">ylab</span>(<span class="st">"Number of weekly suicide"</span>)</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>  figure1 <span class="ot">&lt;-</span> f1 <span class="sc">+</span></span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(ymd2, f3resid), <span class="at">method=</span><span class="st">'gam'</span>, <span class="at">formula=</span>y <span class="sc">~</span><span class="fu">ns</span>(x, <span class="dv">60</span>),</span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">se=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">linetype=</span><span class="st">"solid"</span>, <span class="at">size=</span><span class="fl">0.3</span>, <span class="at">fill =</span> <span class="st">'red'</span>)<span class="sc">+</span></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>( <span class="at">legend.position =</span>   <span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">caption =</span><span class="st">"*Beta = weekly suicide number change by % increment of influenza like illness"</span>,</span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">title=</span><span class="st">""</span><span class="co">#, subtitle="Beta = -0.014, p = 0.158  before 2009\n  Beta =  0.002,  p = 0.011     from 2009"</span></span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">+</span>   <span class="fu">theme</span>(<span class="at">plot.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust=</span><span class="fl">0.5</span>)) <span class="sc">+</span> <span class="co">#face="italic", color="black"))+</span></span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>((<span class="sc">~</span>.<span class="sc">/</span><span class="dv">20</span>), <span class="at">name=</span><span class="st">"Influenza like illness ( per 100 outpatient )"</span>)) <span class="sc">+</span></span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">'2008-09-01'</span>), <span class="at">y =</span> <span class="dv">450</span>, <span class="at">label =</span> <span class="st">'bold("Before 2009 (  )")'</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">'A'</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb107-36"><a href="#cb107-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">'2008-09-01'</span>), <span class="at">y =</span> <span class="dv">430</span>, <span class="at">label =</span> <span class="st">'italic("*Beta = -0.066")'</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">'A'</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb107-37"><a href="#cb107-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">'2008-09-01'</span>), <span class="at">y =</span> <span class="dv">410</span>, <span class="at">label =</span> <span class="st">'italic(" p = 0.214")'</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">'A'</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb107-38"><a href="#cb107-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">shape=</span><span class="cn">FALSE</span>)<span class="sc">+</span></span>
<span id="cb107-39"><a href="#cb107-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">'2012-01-01'</span>), <span class="at">y =</span> <span class="dv">450</span>, <span class="at">label =</span> <span class="st">'bold("From  2009 (  )")'</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">'A'</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb107-40"><a href="#cb107-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">'2012-01-01'</span>), <span class="at">y =</span> <span class="dv">430</span>, <span class="at">label =</span> <span class="st">'italic("*Beta = 0.013")'</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">'A'</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb107-41"><a href="#cb107-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">'2012-01-01'</span>), <span class="at">y =</span> <span class="dv">410</span>, <span class="at">label =</span> <span class="st">'italic(" p = 0.019")'</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">'A'</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb107-42"><a href="#cb107-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">x=</span><span class="fu">as.Date</span>(<span class="st">'2008-06-25'</span>), <span class="at">y=</span><span class="dv">449</span>, <span class="at">size=</span><span class="dv">3</span>, <span class="at">shape=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb107-43"><a href="#cb107-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">x=</span><span class="fu">as.Date</span>(<span class="st">'2013-11-01'</span>), <span class="at">y=</span><span class="dv">449</span>, <span class="at">size=</span><span class="dv">3</span>, <span class="at">shape=</span><span class="dv">19</span>) <span class="sc">+</span></span>
<span id="cb107-44"><a href="#cb107-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">'2009-01-01'</span>), <span class="at">linetype=</span><span class="st">"dotted"</span>, </span>
<span id="cb107-45"><a href="#cb107-45" aria-hidden="true" tabindex="-1"></a>                    <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="co">#+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `&lt;scale&gt;` argument of `guides()` cannot be `FALSE`. Use "none" instead as
of ggplot2 3.3.4.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">#annotate("rect", xmin = as.Date('2004-06-01'), xmax = as.Date('2009-01-01'),  ymin = -50, ymax = 470,</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>     <span class="co">#       alpha = .1)</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>  figure1 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="timeseries_1_files/figure-html/ts fig12-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>여기 까지 실습하시느라 수고하셨습니다. 상기 분석 방법으로 아래 논문을 출판하였습니다. 참고해서 보시면 좋겠습니다. https://journals.plos.org/plosone/article/comments?id=10.1371/journal.pone.0244596</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Dose_Response_Model.html" class="pagination-link" aria-label="Dose Response Model">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Dose Response Model</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./InterruptedTS.html" class="pagination-link" aria-label="중단된 시계열 분석">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">중단된 시계열 분석</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>